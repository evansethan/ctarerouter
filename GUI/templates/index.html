<!DOCTYPE html>
<html>
<head>
    <title>Chicago Stations and Routes</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 90vh; }
        #saveButton {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #007bff;
            color: white;
            padding: 12px 18px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
            transition: background 0.3s;
        }
        #saveButton:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Chicago Stations and Routes</h1>
    <div id="map"></div>
    <div id="saveButton" onclick="saveData()">ðŸ’¾ Save Stations and Routes</div>

    <script>
        const map = L.map('map').setView([41.8781, -87.6298], 11);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap & CartoDB contributors',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        let stations = [];
        let stationMarkers = [];
        let routes = [];
        let routePolylines = [];
        let tempRoute = [];

        // Load existing stations and routes
        fetch('/load')
            .then(response => response.json())
            .then(data => {
                data.stations.forEach(station => {
                    const marker = L.marker([station.lat, station.lng]).addTo(map)
                        .bindPopup(`Station ${station.id}`);
                    stations.push({ id: station.id, lat: station.lat, lng: station.lng });
                    stationMarkers.push(marker);
                });

                data.routes.forEach(route => {
                    const s1 = parseInt(route.s_id1);
                    const s2 = parseInt(route.s_id2);

                    const station1 = stations.find(s => s.id === s1);
                    const station2 = stations.find(s => s.id === s2);

                    if (station1 && station2) {
                        const polyline = L.polyline([
                            [station1.lat, station1.lng],
                            [station2.lat, station2.lng]
                        ], { color: 'blue' }).addTo(map);
                        polyline.routeInfo = { s_id1: s1, s_id2: s2 };
                        routePolylines.push(polyline);
                        routes.push({ s_id1: s1, s_id2: s2 });
                    }
                });
            });

        // Add stations by clicking
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const stationId = stations.length > 0 ? Math.max(...stations.map(s => s.id)) + 1 : 1;

            const marker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`Station ${stationId}`)
                .openPopup();

            stations.push({ id: stationId, lat: lat, lng: lng });
            stationMarkers.push(marker);
        });

        // Add routes by right-clicking two stations
        map.on('contextmenu', function(e) {
            let closestStation = null;
            let closestDistance = Infinity;

            stations.forEach(station => {
                const distance = Math.sqrt(Math.pow(station.lat - e.latlng.lat, 2) + Math.pow(station.lng - e.latlng.lng, 2));
                if (distance < closestDistance) {
                    closestStation = station;
                    closestDistance = distance;
                }
            });

            if (closestStation) {
                tempRoute.push(closestStation.id);

                if (tempRoute.length === 2) {
                    const s1 = tempRoute[0];
                    const s2 = tempRoute[1];

                    routes.push({ s_id1: s1, s_id2: s2 });

                    const station1 = stations.find(s => s.id === s1);
                    const station2 = stations.find(s => s.id === s2);

                    const polyline = L.polyline([
                        [station1.lat, station1.lng],
                        [station2.lat, station2.lng]
                    ], { color: 'blue' }).addTo(map);

                    polyline.routeInfo = { s_id1: s1, s_id2: s2 };
                    routePolylines.push(polyline);

                    tempRoute = [];
                }
            }
        });

        function saveData() {
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({stations: stations, routes: routes})
            }).then(response => {
                if (response.ok) {
                    alert('Saved successfully!');
                } else {
                    alert('Error saving.');
                }
            });
        }
    </script>
</body>
</html>
